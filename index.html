<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zen Breath Trainer (Cloud Sync)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #e6e6e6;
            min-height: 100vh;
        }

        /* Breathing Circle */
        #breathing-circle-container {
            width: 300px;
            height: 300px;
            max-width: 90vw;
            max-height: 90vw;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative; 
        }

        /* Fixed Guide Ring */
        #max-size-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px dashed rgba(79, 70, 229, 0.4); 
            box-sizing: border-box;
            pointer-events: none; 
        }

        #breathing-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.8) 0%, rgba(79, 70, 229, 0.5) 100%);
            box-shadow: 0 0 40px rgba(99, 102, 241, 0.5), 0 0 10px rgba(0, 0, 0, 0.2);
            transform: scale(0.5); 
            transition: transform 0s ease-in-out; 
        }

        /* Active Tab Styling */
        .tab-active {
            border-bottom: 3px solid #6366f1; /* Indigo-500 */
            color: #e6e6e6; 
        }
    </style>

    <!-- Firebase SDK Imports for Cloud Sync -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ----------------------------------------------------------------------
        // âœ… YOUR CUSTOM FIREBASE CONFIGURATION (Provided by the user) âœ…
        // ----------------------------------------------------------------------
        const yourFirebaseConfig = {
            apiKey: "AIzaSyDjtgHP3gx_AV7PX4oJ3l4ZaSKP0vXuNYI",
            authDomain: "zentrainersync.firebaseapp.com",
            projectId: "zentrainersync",
            storageBucket: "zentrainersync.firebasestorage.app", 
            messagingSenderId: "180521552924",
            appId: "1:180521552924:web:0d3437027f12ebb7c5a3d9" 
        };
        // ----------------------------------------------------------------------

        // Boilerplate code to allow this single file to work both locally and on your hosted link
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const activeFirebaseConfig = 
            (typeof __firebase_config !== 'undefined' && Object.keys(firebaseConfig).length > 0) 
            ? firebaseConfig 
            : yourFirebaseConfig;

        let app, db, auth;
        let isTrainingRunning = false;
        let currentRoutine = null;
        let totalDurationSeconds = 0;
        let startTime = 0;
        let animationFrameId;
        let currentScreen = 'routines'; 
        
        let currentPhase; 
        let phaseStartTime; 

        const uiElements = {
            loadingState: document.getElementById('loading-state'),
            appContent: document.getElementById('app-content'),
            userIdDisplay: document.getElementById('user-id-display'),
            routineSelector: document.getElementById('routine-selector'),
            mainScreen: document.getElementById('main-screen'),
            historyScreen: document.getElementById('history-screen'),
            trainingScreen: document.getElementById('training-screen'),
            instructionText: document.getElementById('instruction-text'),
            progressBar: document.getElementById('progress-bar'),
            breathingCircle: document.getElementById('breathing-circle'),
            customRoutineForm: document.getElementById('custom-routine-form'),
            // Tabs
            routinesTabBtn: document.getElementById('routines-tab'),
            historyTabBtn: document.getElementById('history-tab'),
            historyList: document.getElementById('history-list'),
        };
        
        // --- PREDEFINED TRAININGS (SAME) ---
        const builtInRoutines = [
            { id: 'calm', name: 'Calm Down', durationMinutes: 6, inhale: 4, holdIn: 0, exhale: 6, holdOut: 0, isCustom: false },
            { id: 'extended', name: 'Extended Out', durationMinutes: 3, inhale: 4, holdIn: 0, exhale: 12, holdOut: 0, isCustom: false },
            { id: 'box', name: 'Box Breathing (4:4:4:4)', durationMinutes: 6, inhale: 4, holdIn: 4, exhale: 4, holdOut: 4, isCustom: false },
            { id: 'relax', name: 'Relaxation (4:7:8)', durationMinutes: 6, inhale: 4, holdIn: 7, exhale: 8, holdOut: 0, isCustom: false },
        ];
        
        // --- TONE.JS AUDIO SETUP (SAME) ---
        const volumeNode = new Tone.Volume(-16).toDestination(); 
        
        const meditativeSynth = new Tone.FMSynth({
            harmonicity: 0.8,
            modulationIndex: 2,
            envelope: { attack: 0.05, decay: 0.3, sustain: 0.1, release: 0.5 },
            modulation: { type: "triangle" },
            volume: -8 
        }).connect(volumeNode);

        const finishBell = new Tone.MembraneSynth({
            pitchDecay: 0.005,
            octaves: 10,
            envelope: { attack: 0.001, decay: 0.8, sustain: 0.01, release: 1.8 },
            volume: -10
        }).connect(volumeNode);

        async function playSound(type, duration = 0.5) {
            await Tone.start();
            let note;
            switch (type) {
                case 'start': note = "C6"; meditativeSynth.triggerAttackRelease(note, "64n"); break;
                case 'in': note = "G4"; meditativeSynth.triggerAttackRelease(note, "0.1s"); break;
                case 'holdIn': note = "A4"; meditativeSynth.triggerAttackRelease(note, "0.1s"); break;
                case 'out': note = "D4"; meditativeSynth.triggerAttackRelease(note, "0.1s"); break;
                case 'holdOut': note = "C4"; meditativeSynth.triggerAttackRelease(note, "0.1s"); break;
                case 'finish': finishBell.triggerAttackRelease("C3", 2); break;
            }
        }
        
        // --- FIREBASE DATA MANAGEMENT (Routines) ---

        function getTrainingsCollectionRef() {
            if (!db) {
                console.error("Database not initialized.");
                return null;
            }
            const collectionId = activeFirebaseConfig.projectId || appId;
            const collectionPath = `artifacts/${collectionId}/public/data/trainings`;
            return collection(db, collectionPath);
        }

        async function saveCustomRoutine(routine) {
            const ref = getTrainingsCollectionRef();
            if (!ref) return;

            try {
                const routineData = { ...routine, isCustom: true, createdAt: Date.now() };
                await addDoc(ref, routineData);
                showCustomMessage("Routine saved successfully to cloud (syncing enabled)!", "green");
            } catch (e) {
                console.error("Error adding document: ", e);
                showCustomMessage("Failed to save routine. Check console for details.", "red");
            }
        }

        function loadCustomRoutines() {
            const ref = getTrainingsCollectionRef();
            if (!ref) {
                 renderRoutineSelector(builtInRoutines);
                 return;
            }

            const routinesQuery = query(ref, orderBy("createdAt", "desc"));

            // Real-time listener for Routines
            onSnapshot(routinesQuery, (snapshot) => {
                const customRoutines = snapshot.docs.map(doc => ({ 
                    ...doc.data(), 
                    id: doc.id,
                    isCustom: true 
                }));
                
                const allRoutines = [...builtInRoutines, ...customRoutines];
                renderRoutineSelector(allRoutines);

                uiElements.loadingState.classList.add('hidden');
                uiElements.appContent.classList.remove('hidden');
                uiElements.userIdDisplay.textContent = `Sync Status: Cloud Connected (Public Data)`;

            }, (error) => {
                // FALLBACK for chat window or network issues
                console.error("Cloud Sync Error (Using built-in routines):", error);
                renderRoutineSelector(builtInRoutines); 
                uiElements.loadingState.classList.add('hidden');
                uiElements.appContent.classList.remove('hidden');
                uiElements.userIdDisplay.textContent = 'Sync Status: Connection Failed. Please check console for details.';
            });
        }
        
        async function deleteCustomRoutine(id) {
            const ref = getTrainingsCollectionRef();
            if (!ref) return;
            try {
                await deleteDoc(doc(ref, id));
                showCustomMessage("Routine deleted successfully!", "green");
            } catch (e) {
                console.error("Error deleting document: ", e);
                showCustomMessage("Failed to delete routine.", "red");
            }
        }

        // --- FIREBASE DATA MANAGEMENT (History) ---

        function getHistoryCollectionRef() {
             if (!db) return null;
            const collectionId = activeFirebaseConfig.projectId || appId;
            const collectionPath = `artifacts/${collectionId}/public/data/history`; 
            return collection(db, collectionPath);
        }

        async function saveTrainingHistory(routineName, actualDurationSeconds, totalTargetSeconds, completed) {
            const ref = getHistoryCollectionRef();
            if (!ref) return;

            try {
                await addDoc(ref, {
                    routineName: routineName,
                    actualDurationSeconds: Math.floor(actualDurationSeconds),
                    totalTargetSeconds: totalTargetSeconds,
                    completed: completed,
                    timestamp: Date.now(),
                });
                console.log("Training history saved to cloud.");
            } catch (e) {
                console.error("Error saving history: ", e);
            }
        }

        function loadTrainingHistory() {
            const ref = getHistoryCollectionRef();
            if (!ref) {
                uiElements.historyList.innerHTML = '<p class="text-center text-red-400 mt-8">Error: History database not available.</p>';
                return;
            }

            const historyQuery = query(ref, orderBy("timestamp", "desc"));
            
            // Real-time listener for History
            onSnapshot(historyQuery, (snapshot) => {
                uiElements.historyList.innerHTML = '';
                
                if (snapshot.empty) {
                    uiElements.historyList.innerHTML = '<p class="text-center text-gray-500 mt-8">No training sessions recorded yet.</p>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const session = doc.data();
                    const item = createHistoryItem(
                        session.routineName, 
                        session.actualDurationSeconds, 
                        session.totalTargetSeconds, 
                        session.completed, 
                        session.timestamp
                    );
                    uiElements.historyList.appendChild(item);
                });
            }, (error) => {
                console.error("Error loading history:", error);
                uiElements.historyList.innerHTML = `<p class="text-center text-red-400 mt-8">Error loading history: ${error.message}</p>`;
            });
        }
        
        // --- UI RENDERING FUNCTIONS (SAME) ---

        function renderRoutineSelector(routines) {
            const selector = uiElements.routineSelector;
            selector.innerHTML = ''; 
            
            const builtInSection = document.createElement('div');
            builtInSection.className = 'grid grid-cols-2 md:grid-cols-4 gap-3 mb-6';
            
            const customSection = document.createElement('div');
            customSection.className = 'grid grid-cols-2 md:grid-cols-4 gap-3';
            
            routines.forEach(routine => {
                const card = document.createElement('div');
                card.className = `p-4 rounded-xl shadow-lg cursor-pointer transition duration-300 transform hover:scale-[1.03] flex flex-col justify-between ${routine.isCustom ? 'bg-gray-700 hover:bg-gray-600' : 'bg-indigo-600 hover:bg-indigo-700'}`;
                card.dataset.routineId = routine.id;
                
                card.innerHTML = `
                    <h3 class="text-lg font-bold text-white mb-1">${routine.name}</h3>
                    <p class="text-sm text-indigo-200">${routine.inhale}:${routine.holdIn}:${routine.exhale}:${routine.holdOut}</p>
                    <p class="text-xs text-indigo-300">${routine.durationMinutes} min</p>
                    ${routine.isCustom ? `<button class="delete-custom-btn mt-2 text-xs text-red-300 hover:text-red-400 self-end" data-id="${routine.id}">Delete</button>` : ''}
                `;
                
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-custom-btn')) {
                        startCountdown(routine);
                    }
                });


                if (routine.isCustom) {
                    const deleteBtn = card.querySelector('.delete-custom-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            handleDelete(routine.id, routine.name);
                        });
                    }
                    customSection.appendChild(card);
                } else {
                    builtInSection.appendChild(card);
                }
            });

            const builtInHeader = document.createElement('h2');
            builtInHeader.className = 'text-xl font-semibold mb-3 mt-4 text-indigo-300';
            builtInHeader.textContent = 'Predefined Routines';
            selector.appendChild(builtInHeader);
            selector.appendChild(builtInSection);

            if (customSection.children.length > 0) {
                 const customHeader = document.createElement('h2');
                 customHeader.className = 'text-xl font-semibold mb-3 mt-6 text-indigo-300';
                 customHeader.textContent = 'Your Saved Routines';
                 selector.appendChild(customHeader);
                 selector.appendChild(customSection);
            }
        }

        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes} min ${remainingSeconds} sec`;
        }

        function createHistoryItem(name, actualDuration, totalTarget, completed, timestamp) {
            const item = document.createElement('div');
            const bgColor = completed ? 'bg-green-900/20 hover:bg-green-900/30' : 'bg-red-900/20 hover:bg-red-900/30';
            const statusText = completed 
                ? '<span class="text-xs font-bold text-green-400">Completed</span>'
                : `<span class="text-xs font-bold text-red-400">Stopped</span>`;

            item.className = `p-4 rounded-lg shadow-md flex justify-between items-center transition duration-200 ${bgColor}`;

            const date = new Date(timestamp);
            const formattedDate = date.toLocaleDateString();
            const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const durationText = completed 
                ? formatDuration(actualDuration)
                : `${formatDuration(actualDuration)} / ${formatDuration(totalTarget)}`;
            
            const durationColor = completed ? 'text-green-300' : 'text-red-300';

            item.innerHTML = `
                <div>
                    <p class="text-lg font-semibold text-indigo-300 mb-1">${name}</p>
                    <p class="text-xs text-gray-400">
                        ${statusText}
                        <span class="${durationColor} ml-2">${durationText}</span>
                    </p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-300">${formattedDate}</p>
                    <p class="text-xs text-gray-400">${formattedTime}</p>
                </div>
            `;
            return item;
        }

        function showCustomMessage(message, type = "blue") {
            const msgEl = document.getElementById('notification-message');
            msgEl.textContent = message;
            msgEl.className = `p-3 rounded-lg text-sm text-center font-semibold mb-4 w-full 
                ${type === 'green' ? 'bg-green-600 text-white' : 'bg-blue-600 text-white'}`;
            msgEl.classList.remove('hidden');
            setTimeout(() => { msgEl.classList.add('hidden'); }, 3000);
        }
        
        function resetCircleVisuals() {
            const circle = uiElements.breathingCircle;
            circle.style.transitionDuration = '0s'; 
            void circle.offsetWidth; 
        }

        function transitionCircle(scaleTarget, duration) {
            const circle = uiElements.breathingCircle;
            
            requestAnimationFrame(() => {
                circle.style.transitionDuration = '0s';
                requestAnimationFrame(() => {
                    circle.style.transitionDuration = `${duration}s`;
                    requestAnimationFrame(() => {
                        circle.style.transform = `scale(${scaleTarget})`;
                    });
                });
            });
        }


        // --- CORE LOGIC (SAME) ---

        function switchTab(tabName) {
            currentScreen = tabName;
            
            uiElements.routinesTabBtn.classList.remove('tab-active');
            uiElements.historyTabBtn.classList.remove('tab-active');

            uiElements.mainScreen.classList.add('hidden');
            uiElements.historyScreen.classList.add('hidden');
            
            if (tabName === 'routines') {
                uiElements.routinesTabBtn.classList.add('tab-active');
                uiElements.mainScreen.classList.remove('hidden');
            } else if (tabName === 'history') {
                uiElements.historyTabBtn.classList.add('tab-active');
                uiElements.historyScreen.classList.remove('hidden');
                loadTrainingHistory();
            }
        }


        function startCountdown(routine) {
            if (isTrainingRunning) return;
            currentRoutine = routine;
            isTrainingRunning = true;
            
            uiElements.mainScreen.classList.add('hidden');
            uiElements.historyScreen.classList.add('hidden'); 
            uiElements.trainingScreen.classList.remove('hidden');

            uiElements.instructionText.textContent = `Get Ready: ${routine.name}`;
            
            uiElements.progressBar.style.width = '0%';
            
            resetCircleVisuals(); 
            uiElements.breathingCircle.style.transform = 'scale(0.5)';
            
            let countdown = 3;
            uiElements.instructionText.textContent = `STARTING IN ${countdown}...`;
            playSound('start'); 
            
            const interval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    uiElements.instructionText.textContent = `STARTING IN ${countdown}...`;
                    playSound('start'); 
                } else {
                    clearInterval(interval);
                    runTraining(); 
                }
            }, 1000);
        }

        function transitionToFirstPhase(phases) {
            const firstPhase = phases[0];
            uiElements.instructionText.textContent = firstPhase.name;
            playSound(firstPhase.key, firstPhase.duration);
            
            const duration = firstPhase.duration;

            if (firstPhase.key === 'in') {
                transitionCircle(1.0, duration);
            } 
            else if (firstPhase.key === 'holdIn') {
                transitionCircle(1.0, 0.1);
            }
            else if (firstPhase.key === 'out') {
                transitionCircle(0.5, duration);
            } 
            else if (firstPhase.key === 'holdOut') {
                transitionCircle(0.5, 0.1);
            }
            
            currentPhase = 0;
            phaseStartTime = Date.now();
        }

        function runTraining() {
            startTime = Date.now();
            totalDurationSeconds = currentRoutine.durationMinutes * 60;
            
            let elapsedTotalTime = 0;

            const phases = [
                { name: "BREATH IN", key: 'in', duration: currentRoutine.inhale },
                { name: "HOLD", key: 'holdIn', duration: currentRoutine.holdIn },
                { name: "BREATH OUT", key: 'out', duration: currentRoutine.exhale },
                { name: "HOLD OUT", key: 'holdOut', duration: currentRoutine.holdOut }
            ].filter(p => p.duration > 0); 

            transitionToFirstPhase(phases);

            const updateLoop = (timestamp) => {
                if (!isTrainingRunning) return;

                const timeSinceLastPhase = (Date.now() - phaseStartTime) / 1000;
                
                if (timeSinceLastPhase >= phases[currentPhase].duration) {
                    phaseStartTime = Date.now();
                    
                    currentPhase = (currentPhase + 1) % phases.length;

                    const nextPhase = phases[currentPhase];
                    uiElements.instructionText.textContent = nextPhase.name;
                    playSound(nextPhase.key, nextPhase.duration);

                    const duration = nextPhase.duration;
                    if (nextPhase.key === 'in') {
                        transitionCircle(1.0, duration);
                    } else if (nextPhase.key === 'holdIn') {
                        transitionCircle(1.0, 0.1); 
                    } else if (nextPhase.key === 'out') {
                        transitionCircle(0.5, duration);
                    } else if (nextPhase.key === 'holdOut') {
                        transitionCircle(0.5, 0.1); 
                    }
                }

                elapsedTotalTime = (Date.now() - startTime) / 1000;
                uiElements.progressBar.style.width = `${(elapsedTotalTime / totalDurationSeconds) * 100}%`;

                if (elapsedTotalTime >= totalDurationSeconds) {
                    const remainingTimeInCurrentPhase = phases[currentPhase].duration - timeSinceLastPhase;

                    if (elapsedTotalTime >= totalDurationSeconds && remainingTimeInCurrentPhase <= 0) {
                         stopTraining(true);
                         return;
                    }
                }
                
                animationFrameId = requestAnimationFrame(updateLoop);
            };
            
            animationFrameId = requestAnimationFrame(updateLoop);
        }

        function stopTraining(completed = false) {
            isTrainingRunning = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            
            // --- HISTORY LOGIC RUNS REGARDLESS OF COMPLETION STATUS ---
            if (currentRoutine) {
                const actualDurationSeconds = (Date.now() - startTime) / 1000;
                const totalTargetSeconds = currentRoutine.durationMinutes * 60;
                
                if (actualDurationSeconds > 5) {
                    saveTrainingHistory(
                        currentRoutine.name, 
                        actualDurationSeconds, 
                        totalTargetSeconds, 
                        completed
                    );
                }
            }
            // --- END HISTORY LOGIC ---

            resetCircleVisuals(); 
            uiElements.breathingCircle.style.transform = 'scale(0.5)';
            uiElements.breathingCircle.style.transitionDuration = '0s'; 

            if (completed) {
                uiElements.instructionText.textContent = "TRAINING COMPLETE!";
                playSound('finish');
            } else {
                uiElements.instructionText.textContent = "Paused";
            }
            
            document.getElementById('stop-btn').classList.add('hidden');
            document.getElementById('back-btn').classList.remove('hidden');
        }
        
        // --- EVENT HANDLERS (SAME) ---
        
        function handleCreateRoutine(event) {
            event.preventDefault();
            
            const name = document.getElementById('input-name').value.trim();
            const inhale = parseInt(document.getElementById('input-in').value);
            const holdIn = parseInt(document.getElementById('input-hold-in').value);
            const exhale = parseInt(document.getElementById('input-out').value);
            const holdOut = parseInt(document.getElementById('input-hold-out').value);
            const minutes = parseInt(document.getElementById('input-minutes').value);
            
            if (!name || isNaN(inhale) || isNaN(holdIn) || isNaN(exhale) || isNaN(holdOut) || isNaN(minutes) || minutes < 1 || (inhale + holdIn + exhale + holdOut) === 0) {
                showCustomMessage("Please check all inputs. Name is required, duration must be at least 1 minute, and the total phase time must be greater than zero.", "red");
                return;
            }

            const newRoutine = {
                name: name,
                durationMinutes: minutes,
                inhale: inhale,
                holdIn: holdIn,
                exhale: exhale,
                holdOut: holdOut,
            };
            
            saveCustomRoutine(newRoutine);
            uiElements.customRoutineForm.reset();
        }

        function handleDelete(id, name) {
            const deleteModal = document.getElementById('delete-modal');
            document.getElementById('delete-routine-name').textContent = name;
            document.getElementById('confirm-delete-btn').onclick = () => {
                deleteCustomRoutine(id);
                deleteModal.classList.add('hidden');
            };
            document.getElementById('cancel-delete-btn').onclick = () => {
                deleteModal.classList.add('hidden');
            };
            deleteModal.classList.remove('hidden');
        }

        function handleBackToMain() {
            if (isTrainingRunning) {
                stopTraining(false);
            }
            
            uiElements.trainingScreen.classList.add('hidden');
            
            if (currentScreen === 'history') {
                switchTab('history');
            } else {
                 switchTab('routines');
            }
            
            document.getElementById('stop-btn').classList.remove('hidden');
            document.getElementById('back-btn').classList.add('hidden');
        }

        // --- INITIALIZATION ---

        async function initializeFirebase() {
            try {
                app = initializeApp(activeFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);

                loadCustomRoutines(); 
                
            } catch (error) {
                console.error("Fatal Error Initializing Cloud Sync:", error);
                
                // Fallback UI on failure
                renderRoutineSelector(builtInRoutines);
                uiElements.loadingState.classList.add('hidden');
                uiElements.appContent.classList.remove('hidden');
                uiElements.userIdDisplay.textContent = 'Sync Status: Connection Failed. Please check console for details.';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            uiElements.routinesTabBtn.addEventListener('click', () => switchTab('routines'));
            uiElements.historyTabBtn.addEventListener('click', () => switchTab('history'));
            
            document.getElementById('stop-btn').addEventListener('click', () => stopTraining(false));
            document.getElementById('back-btn').addEventListener('click', handleBackToMain);
            uiElements.customRoutineForm.addEventListener('submit', handleCreateRoutine);

            initializeFirebase();
            switchTab('routines'); 
        });

    </script>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="mb-6 border-b border-indigo-900 pb-4">
            <h1 class="text-3xl font-extrabold text-indigo-400">Zen Breath Trainer ðŸ§˜</h1>
            <p id="user-id-display" class="text-xs text-gray-500 mt-2 break-all">Sync Status: Connecting to Cloud...</p>
        </header>

        <!-- Loading State --><div id="loading-state" class="text-center p-8 bg-gray-800 rounded-xl shadow-md">
            <p class="text-indigo-400 font-semibold">Establishing secure cloud connection...</p>
        </div>

        <!-- App Content (Hidden until loaded) --><div id="app-content" class="hidden">
            
            <!-- Tab Navigation --><div id="tabs" class="flex border-b border-indigo-900 mb-6">
                <button id="routines-tab" class="py-2 px-4 text-sm font-semibold text-gray-400 transition duration-150 hover:text-white tab-active">
                    Routines & Create
                </button>
                <button id="history-tab" class="py-2 px-4 text-sm font-semibold text-gray-400 transition duration-150 hover:text-white">
                    Training History
                </button>
            </div>
            
            
            <!-- Main Routine Selection Screen --><div id="main-screen" class="space-y-8">
                
                <!-- Notification Message --><div id="notification-message" class="hidden"></div>
                
                <!-- Routine Selector (Includes Built-in and Saved) --><div id="routine-selector" class="rounded-xl p-4 bg-gray-800 shadow-xl">
                    <!-- Routines injected here by JS --></div>

                <!-- Create Custom Routine Form --><div class="bg-gray-800 p-6 rounded-xl shadow-xl border border-indigo-900">
                    <h2 class="text-xl font-semibold text-indigo-400 mb-4">Create & Save Custom Routine</h2>
                    <form id="custom-routine-form" class="space-y-4">
                        <input type="text" id="input-name" placeholder="Routine Name (e.g., Deep Focus)" required
                               class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-white">
                        
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Phase Inputs --><div class="col-span-1">
                                <label for="input-in" class="block text-sm font-medium text-gray-400">Inhale (seconds)</label>
                                <input type="number" id="input-in" value="4" min="0" required
                                       class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-white">
                            </div>
                            <div class="col-span-1">
                                <label for="input-hold-in" class="block text-sm font-medium text-gray-400">Hold In (seconds)</label>
                                <input type="number" id="input-hold-in" value="0" min="0" required
                                       class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-white">
                            </div>
                            <div class="col-span-1">
                                <label for="input-out" class="block text-sm font-medium text-gray-400">Exhale (seconds)</label>
                                <input type="number" id="input-out" value="6" min="0" required
                                       class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-white">
                            </div>
                            <div class="col-span-1">
                                <label for="input-hold-out" class="block text-sm font-medium text-gray-400">Hold Out (seconds)</label>
                                <input type="number" id="input-hold-out" value="0" min="0" required
                                       class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-white">
                            </div>
                        </div>

                        <!-- Duration Input --><div>
                             <label for="input-minutes" class="block text-sm font-medium text-gray-400">Total Duration (minutes)</label>
                             <input type="number" id="input-minutes" value="5" min="1" required
                                    class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-white">
                        </div>
                        
                        <button type="submit"
                                class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg hover:shadow-xl transform hover:scale-[1.01]">
                            Save Routine to Cloud (Sync)
                        </button>
                    </form>
                </div>
            </div>

            <!-- History Screen (NEW) --><div id="history-screen" class="hidden">
                <h2 class="text-2xl font-semibold text-indigo-400 mb-4">Training History</h2>
                <div id="history-list" class="space-y-4 max-h-[60vh] overflow-y-auto p-2">
                    <!-- History items injected here by JS -->
                </div>
            </div>

            <!-- Training Screen --><div id="training-screen" class="hidden text-center flex flex-col items-center justify-center min-h-[60vh]">
                <div id="breathing-circle-container" class="mb-12">
                    <!-- Guide Ring for Max Size --><div id="max-size-ring"></div>
                    <div id="breathing-circle"></div>
                </div>

                <p id="instruction-text" class="text-4xl font-extrabold text-indigo-300 mb-8 transition-colors duration-500">Get Ready</p>
                
                <!-- Progress Bar --><div class="w-full max-w-xs bg-gray-700 rounded-full h-2.5 mb-8">
                    <div id="progress-bar" class="bg-indigo-500 h-2.5 rounded-full transition-all duration-100 ease-linear" style="width: 0%"></div>
                </div>

                <div class="flex space-x-4">
                    <button id="stop-btn"
                            class="px-6 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-300 shadow-md transform active:scale-95">
                        Stop Training
                    </button>
                    <button id="back-btn" class="px-6 py-3 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700 transition duration-300 shadow-md transform active:scale-95 hidden">
                        Back to Routines
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Confirmation Modal for Deletion --><div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden transition-opacity duration-300">
        <div class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-sm p-6 bg-gray-800 rounded-xl shadow-2xl">
            <h3 class="text-xl font-bold text-red-400 mb-4">Confirm Deletion</h3>
            <p class="text-gray-300 mb-6">Are you sure you want to delete the custom routine: <span id="delete-routine-name" class="font-semibold text-white"></span>?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-btn"
                        class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition duration-150">
                    Cancel
                </button>
                <button id="confirm-delete-btn"
                        class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>

</body>
</html>
